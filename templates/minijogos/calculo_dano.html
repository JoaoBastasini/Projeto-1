<!DOCTYPE html>

<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css">
    
    <title>C√°lculo de dano</title>
</head>
<body>

    <svg class="svg_centralizado" width="450" height="150" viewBox="0 0 500 200">
        <defs>
            <path id="img_curvada" d="M 10,180 Q 250,20 490,180" /> 
        </defs>
        <text class="img_titulo">
            <textPath href="#img_curvada" startOffset="50%" textLength="480" lengthAdjust="spacingAndGlyphs">
            C√°lculo de Dano
            </textPath>
        </text>
    </svg>
    
    <div class="container">
        <h3 style="text-align: center;">Selecione o N√≠vel de Dificuldade:</h3>
        
        <div class="botoes_nivel">
            <button class="facil" onclick="startChallenge('facil')">F√ÅCIL</button>
            <button class="medio" onclick="startChallenge('medio')">M√âDIO</button>
            <button class="dificil" onclick="startChallenge('dificil')">DIF√çCIL</button>
        </div>
        
        <div id="challenge_area" style="display: none;">
            <hr>
            <h2 id="challenge_title">Desafio de C√°lculo - N√≠vel: <span id="level_name"></span></h2>
            
            <div class="info_box">
                <div class="grade_stats">
                    <div>
                        <p><strong>‚öîÔ∏è ATACANTE:</strong> <span id="attacker_name"></span> (N√≠vel <span id="level"></span>)</p>
                        <p><strong>Tipos:</strong> <span id="attacker_types"></span></p>
                        <p class="item_stats"><strong><span id="att_stat_name"></span>:</strong> <span id="att_value"></span></p>
                    </div>
                    <div>
                        <p><strong>üõ°Ô∏è DEFENSOR:</strong> <span id="defender_name"></span></p>
                        <p><strong>Tipos:</strong> <span id="defender_types"></span></p>
                        <p class="item_stats"><strong><span id="def_stat_name"></span>:</strong> <span id="def_value"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="info_box">
                <p><strong>üí• Ataque:</strong> <span id="attack_type"></span> (Poder <span id="power"></span>)</p>
                <p><strong>‚≠ê STAB:</strong> x<span id="stab_mod"></span></p>
                <p><strong>üìà Efic√°cia de Tipo:</strong> x<span id="type_effectiveness"></span></p>
            </div>
            
            <div class="formula_LaTex">
                <h3>F√≥rmula: <span id="level_name_formula"></span></h3>
                <p id="level_description" style="font-style: italic; color: #555;"></p>
                <div id="formula_equation" style="font-size: 1.5em; margin: 10px;"></div>
                <p id="formula_values" style="margin-top: 10px;"></p>
                <p id="formula_warning" style="color: #d9534f; font-weight: bold;"></p>
            </div>

            <div class="grupo_entrada">
                <label for="user_answer">Sua Resposta (Dano ou Faixa [Min-Max]):</label><br>
                <input type="text" id="user_answer" placeholder="Ex: 50 ou 42-50">
                <button class="botao_minijogo" onclick="checkAnswer()">Confirmar</button>
            </div>
            
            <div id="result_message" class="resultado_box" style="display: none;"></div>
            
            <button class="botao_minijogo" style="margin-top: 20px; display: none;" id="new_challenge_btn" onclick="startChallenge(currentLevel)">Novo Desafio</button>
        </div>

    </div>

    <script>
        // Vari√°veis globais para armazenar o estado do jogo
        let currentLevel = null; // N√≠vel atual ('facil', 'medio', 'dificil')
        let correctAnswer = null; // Resposta correta (para F√°cil/M√©dio)
        let correctRangeMin = null; // M√≠nimo da faixa de dano (para Dif√≠cil)
        let correctRangeMax = null; // M√°ximo da faixa de dano (para Dif√≠cil)


        // =======================================================
        // FUN√á√ÉO: startChallenge(nivel)
        // Inicia um novo desafio, buscando os dados no backend (Flask).
        // =======================================================
        function startChallenge(nivel) {
            currentLevel = nivel;
            
            // 1. Resetar a interface e mostrar a √°rea do desafio
            document.getElementById('challenge_area').style.display = 'block';
            document.getElementById('result_message').style.display = 'none';
            document.getElementById('user_answer').value = '';
            document.getElementById('new_challenge_btn').style.display = 'none';
            document.getElementById('formula_warning').innerHTML = '';
            
            // 2. Chamada AJAX (Fetch API) para o endpoint do Flask
            fetch('/api/iniciar_calculo', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                // Envia o n√≠vel de dificuldade escolhido
                body: JSON.stringify({ nivel: nivel })
            })
            // 3. Processa a resposta JSON do Flask
            .then(response => response.json())
            .then(data => {
                if (data.erro) { // Verifica se h√° erro no carregamento dos dados
                    alert(data.erro);
                    return;
                }

                // 4. Armazena as respostas corretas nas vari√°veis globais
                correctAnswer = data.formula.answer_for_level;
                correctRangeMin = data.formula.range_min;
                correctRangeMax = data.formula.range_max;

                // 5. Preenche os campos do HTML com os dados da batalha
                document.getElementById('level_name').textContent = data.formula.name;
                document.getElementById('level_name_formula').textContent = data.formula.name;
                document.getElementById('level_description').textContent = data.formula.description; // Nova descri√ß√£o do n√≠vel
                
                document.getElementById('attacker_name').textContent = data.battle.attacker;
                document.getElementById('defender_name').textContent = data.battle.defender;
                document.getElementById('level').textContent = data.battle.level;
                // ... preenchimento dos demais campos (tipos, stats, poder, stab, efic√°cia) ...
                document.getElementById('attacker_types').textContent = data.battle.attacker_types;
                document.getElementById('defender_types').textContent = data.battle.defender_types;
                document.getElementById('att_stat_name').textContent = data.battle.att_stat_name;
                document.getElementById('att_value').textContent = data.battle.att_value;
                document.getElementById('def_stat_name').textContent = data.battle.def_stat_name;
                document.getElementById('def_value').textContent = data.battle.def_value;
                document.getElementById('attack_type').textContent = data.battle.attack_type;
                document.getElementById('power').textContent = data.battle.power;
                document.getElementById('stab_mod').textContent = data.battle.stab_mod;
                document.getElementById('type_effectiveness').textContent = data.battle.type_effectiveness;


                // 6. Renderiza a f√≥rmula LaTeX usando KaTeX
                const formulaElement = document.getElementById('formula_equation');
                katex.render(data.formula.equation_tex, formulaElement, {
                    throwOnError: false // N√£o quebra se houver erro de sintaxe LaTeX
                });


                // 7. Preenche os valores num√©ricos a serem substitu√≠dos na f√≥rmula
                let valuesHtml = 'Valores a Substituir: ';
                const values = data.formula.values;
                // Mapeia o dicion√°rio de valores para strings formatadas (Ex: 'N√≠vel = 50 | Poder = 80')
                valuesHtml += Object.keys(values).map(key => `<strong>${key}</strong> = ${values[key]}`).join(' | ');
                document.getElementById('formula_values').innerHTML = valuesHtml;

                // 8. Define avisos espec√≠ficos de arredondamento ou faixa de dano
                if (nivel === 'medio') {
                    document.getElementById('formula_warning').innerHTML = 'Lembre-se: Arredonde para baixo o valor final! (Fun√ß√£o $\\lfloor x \\rfloor$)';
                } else if (nivel === 'dificil') {
                     document.getElementById('formula_warning').innerHTML = 'Sua resposta deve ser a FAIXA DE DANO (Ex: Min-Max). Fator Aleat√≥rio: 0.85 a 1.0.';
                }

            })
            .catch(error => {
                console.error('Erro ao iniciar o desafio:', error);
                alert('Erro ao carregar desafio. Verifique o console.');
            });
        }


        // =======================================================
        // FUN√á√ÉO: checkAnswer()
        // Verifica a resposta do usu√°rio contra a resposta correta.
        // =======================================================
        function checkAnswer() {
            const userAnswer = document.getElementById('user_answer').value.trim();
            const resultMessage = document.getElementById('result_message');
            const newChallengeBtn = document.getElementById('new_challenge_btn');
            
            let isCorrect = false;

            // L√≥gica para N√≠vel DIF√çCIL (espera formato Min-Max)
            if (currentLevel === 'dificil') {
                // Divide a string do usu√°rio em dois n√∫meros (ex: "42-50" -> ["42", "50"])
                const parts = userAnswer.split('-').map(p => p.trim());
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    const userMin = parseInt(parts[0]);
                    const userMax = parseInt(parts[1]);
                    // Compara se a faixa inserida √© igual √† faixa correta
                    if (userMin === correctRangeMin && userMax === correctRangeMax) {
                        isCorrect = true;
                    }
                }
            } 
            // L√≥gica para N√≠vel F√ÅCIL e M√âDIO (espera um √∫nico n√∫mero)
            else {
                const userNumber = parseInt(userAnswer);
                // Compara se o n√∫mero inserido (inteiro) √© igual √† resposta correta
                if (!isNaN(userNumber) && userNumber === correctAnswer) {
                    isCorrect = true;
                }
            }
            
            // 1. Exibir resultado e bot√£o de novo desafio
            resultMessage.style.display = 'block';
            newChallengeBtn.style.display = 'block';

            // 2. Aplicar estilos e exibir mensagem
            if (isCorrect) {
                resultMessage.className = 'resultado_box correto'; // Aplica classe de sucesso (verde)
                resultMessage.innerHTML = `‚úÖ Correto! O dano final √©: <strong>${correctAnswer}</strong>.`;
            } else {
                resultMessage.className = 'resultado_box incorreto'; // Aplica classe de erro (vermelho)
                // Formata a resposta correta para ser exibida
                let correctDisplay = currentLevel === 'dificil' ? `[${correctRangeMin} - ${correctRangeMax}]` : correctAnswer;
                resultMessage.innerHTML = `‚ùå Incorreto! A resposta correta era: <strong>${correctDisplay}</strong>.`;
                
                // Op√ß√£o para dar uma dica extra nos n√≠veis M√©dio/Dif√≠cil
                if (currentLevel === 'medio' || currentLevel === 'dificil') {
                    // Chamada separada para buscar o valor base (ap√≥s a falha), se necess√°rio
                    fetch('/api/iniciar_calculo', { 
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ nivel: currentLevel }) 
                    })
                    .then(r => r.json())
                    .then(data => {
                        // Exibe o valor do c√°lculo Base (antes de aplicar STAB/Efic√°cia/Aleat√≥rio)
                        resultMessage.innerHTML += `<br>Dica: O valor base (antes de STAB/Efic√°cia) √© aprox.: <strong>${data.base_calc_no_random}</strong>.`;
                    });
                }
            }
        }
    </script>
</body>
</html>